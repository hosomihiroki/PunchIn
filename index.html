<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>PunchIn å‡ºå‹¤å ±å‘Š</title>
  <style>
    :root {
      --primary: #007bff;
      --bg: #f0f2f5;
      --card-bg: #fff;
      --text: #333;
      --border: #ddd;
      --radius: 8px;
      --transition: 0.2s;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #container {
      width: 320px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
    }
    h2 {
      margin: 0 0 1.5rem;
      font-size: 1.5rem;
      color: var(--primary);
    }
    label { display: block; text-align: left; font-size: 0.9rem; margin-bottom: 0.5rem; }
    input { width: 100%; padding: 0.6rem; margin-bottom: 1rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 1rem; transition: border-color var(--transition); }
    input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2); }
    button { width: 100%; padding: 0.8rem; background: var(--primary); color: #fff; border: none; border-radius: var(--radius); font-size: 1rem; cursor: pointer; transition: background var(--transition), transform var(--transition); }
    button:hover:not(:disabled) { background: #0056b3; }
    button:active:not(:disabled) { transform: scale(0.98); }
    button:disabled { background: #aaa; cursor: default; }
    #loadingSpinner { width: 24px; height: 24px; margin: 1rem auto; border: 3px solid var(--border); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #messageArea { margin-top: 1rem; color: var(--text); font-size: 0.95rem; min-height: 1.2em; }
  </style>
</head>
<body>
  <div id="container">
    <h2>PunchIn å‡ºå‹¤å ±å‘Š</h2>
    <label for="staffIdInput">ç¤¾å“¡ç•ªå·</label>
    <input list="historyList" type="text" id="staffIdInput" placeholder="AN0000">
    <datalist id="historyList"></datalist>
    <button id="confirmBtn">ç¢ºèª</button>
    <div id="loadingSpinner"></div>
    <div id="messageArea"></div>
  </div>

  <script>
    const HISTORY_KEY = 'punchin_staff_history';
    const MESSAGES = [
      "ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ï¼",
      "ä»Šæ—¥ã‚‚ãƒ•ã‚¡ã‚¤ãƒˆã ã‚ˆï¼",
      "è¡Œã£ã¦ã‚‰ã£ã—ã‚ƒã„ã¾ã›ğŸ˜Š",
      "ãŒã‚“ã°ã£ã¦ã­ï¼",
      "æœ€é«˜ã®ä¸€æ—¥ã«ã—ã‚ˆã†ï¼"
    ];
    function getRandomMessage() {
      return MESSAGES[Math.floor(Math.random() * MESSAGES.length)];
    }
    function loadHistory() {
      const list = document.getElementById('historyList'); list.innerHTML = '';
      const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      history.forEach(id => { const opt = document.createElement('option'); opt.value = id; list.appendChild(opt); });
    }
    function saveHistory(id) {
      let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      if (!history.includes(id)) { history.unshift(id); if (history.length > 10) history.pop(); localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); }
    }
    loadHistory();

    document.getElementById('confirmBtn').addEventListener('click', async () => {
      const input = document.getElementById('staffIdInput');
      const msgArea = document.getElementById('messageArea');
      const staffId = input.value.trim();
      if (!staffId) {
        msgArea.textContent = 'ç¤¾å“¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return;
      }
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åç¢ºèª
      try {
        const res = await fetch(
          'https://script.google.com/macros/s/AKfycbzCejPav3a8SrBSQvQSNRm3XOmnsm-cDA-ZQtserkMsCjMuEQ-ci8t6V0AeebFHpj8ebA/exec' +
          `?path=user&staffId=${encodeURIComponent(staffId)}&token=my-secret-token`
        );
        const user = await res.json();
        if (user.error) { msgArea.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'; return; }
        // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        const ok = confirm(`ç¤¾å“¡ç•ªå·: ${staffId}\nåå‰: ${user.name}\n\nã‚ˆã‚ã—ã‘ã‚Œã°OKã€ä¿®æ­£ãªã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«`);
        if (!ok) { location.reload(); return; }
      } catch {
        msgArea.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§ã™'; return;
      }
      // ç¢ºèªå¾Œï¼šå‡ºå‹¤å‡¦ç†
      saveHistory(staffId); loadHistory();
      const btn = document.getElementById('confirmBtn'); const spinner = document.getElementById('loadingSpinner');
      btn.disabled = true; spinner.style.display = 'block'; msgArea.textContent = '';
      const today = new Date(); const y = today.getFullYear(), m = today.getMonth()+1, d = today.getDate();
      // ã‚·ãƒ•ãƒˆå–å¾—
      const shiftRes = await fetch(
        'https://script.google.com/macros/s/AKfycbzCejPav3a8SrBSQvQSNRm3XOmnsm-cDA-ZQtserkMsCjMuEQ-ci8t6V0AeebFHpj8ebA/exec' +
        `?path=shifts&year=${y}&month=${m}&day=${d}&staffId=${encodeURIComponent(staffId)}&token=my-secret-token`
      );
      const shifts = await shiftRes.json();
      const me = shifts.find(item => item.staffId === staffId);
      if (me) {
        alert(`${user.name}ã•ã‚“ã€ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™\nåº—èˆ—ï¼š${me.store}\nå¿œæ´ï¼š${getRandomMessage()}`);
      } else {
        alert('æœ¬æ—¥ã®ã‚·ãƒ•ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }
      // TODO: ã“ã“ã§ clockIn API å‘¼ã³å‡ºã—ãªã©
      btn.disabled = false; spinner.style.display = 'none';
    });
  </script>
</body>
</html>
